import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { merge } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { KeyboardEventsService } from './keyboard-events.service';
import { CONFIG } from './tokens';
import * as i0 from "@angular/core";
import * as i1 from "./keyboard-events.service";
const SUPPORTED_META_KEYS = {
    alt: true,
    shift: true,
    meta: true,
    ctrl: true,
};
const SUPPORTED_KEYS = /[a-z]/;
const META_KEY = 'meta';
const KEY_ALIASES = {
    [META_KEY]: ['ctrl', 'meta'],
};
const SUPPORTED_SHORTCUTS = {
    moveRangeStart: true,
    disableSelection: true,
    toggleSingleItem: true,
    addToSelection: true,
    removeFromSelection: true,
};
const ERROR_PREFIX = '[ShortcutService]';
export class ShortcutService {
    constructor(platformId, config, keyboardEvents) {
        this.platformId = platformId;
        this.keyboardEvents = keyboardEvents;
        this._shortcuts = {};
        this._latestShortcut = new Map();
        this._shortcuts = this._createShortcutsFromConfig(config.shortcuts);
        if (isPlatformBrowser(this.platformId)) {
            const keydown$ = this.keyboardEvents.keydown$.pipe(map((event) => ({ code: event.code, pressed: true })));
            const keyup$ = this.keyboardEvents.keyup$.pipe(map((event) => ({ code: event.code, pressed: false })));
            merge(keydown$, keyup$)
                .pipe(distinctUntilChanged((prev, curr) => {
                return prev.pressed === curr.pressed && prev.code === curr.code;
            }))
                .subscribe((keyState) => {
                if (keyState.pressed) {
                    this._latestShortcut.set(keyState.code, true);
                }
                else {
                    this._latestShortcut.delete(keyState.code);
                }
            });
        }
    }
    disableSelection(event) {
        return this._isShortcutPressed('disableSelection', event);
    }
    moveRangeStart(event) {
        return this._isShortcutPressed('moveRangeStart', event);
    }
    toggleSingleItem(event) {
        return this._isShortcutPressed('toggleSingleItem', event);
    }
    addToSelection(event) {
        return this._isShortcutPressed('addToSelection', event);
    }
    removeFromSelection(event) {
        return this._isShortcutPressed('removeFromSelection', event);
    }
    extendedSelectionShortcut(event) {
        return this.addToSelection(event) || this.removeFromSelection(event);
    }
    _createShortcutsFromConfig(shortcuts) {
        const shortcutMap = {};
        for (const [key, shortcutsForCommand] of Object.entries(shortcuts)) {
            if (!this._isSupportedShortcut(key)) {
                throw new Error(this._getErrorMessage(`Shortcut ${key} not supported`));
            }
            shortcutsForCommand
                .replace(/ /g, '')
                .split(',')
                .forEach((shortcut) => {
                if (!shortcutMap[key]) {
                    shortcutMap[key] = [];
                }
                const combo = shortcut.split('+');
                const cleanCombos = this._substituteKey(shortcut, combo, META_KEY);
                cleanCombos.forEach((cleanCombo) => {
                    const unsupportedKey = this._isSupportedCombo(cleanCombo);
                    if (unsupportedKey) {
                        throw new Error(this._getErrorMessage(`Key '${unsupportedKey}' in shortcut ${shortcut} not supported`));
                    }
                    shortcutMap[key].push(cleanCombo.map((comboKey) => {
                        return SUPPORTED_META_KEYS[comboKey] ? `${comboKey}Key` : `Key${comboKey.toUpperCase()}`;
                    }));
                });
            });
        }
        return shortcutMap;
    }
    _substituteKey(shortcut, combo, substituteKey) {
        const hasSpecialKey = shortcut.includes(substituteKey);
        const substitutedShortcut = [];
        if (hasSpecialKey) {
            const cleanShortcut = combo.filter((element) => element !== META_KEY);
            KEY_ALIASES.meta.forEach((alias) => {
                substitutedShortcut.push([...cleanShortcut, alias]);
            });
        }
        else {
            substitutedShortcut.push(combo);
        }
        return substitutedShortcut;
    }
    _getErrorMessage(message) {
        return `${ERROR_PREFIX} ${message}`;
    }
    _isShortcutPressed(shortcutName, event) {
        const shortcuts = this._shortcuts[shortcutName];
        return shortcuts.some((shortcut) => {
            return shortcut.every((key) => this._isKeyPressed(event, key));
        });
    }
    _isKeyPressed(event, key) {
        return key.startsWith('Key') ? this._latestShortcut.has(key) : event[key];
    }
    _isSupportedCombo(combo) {
        let unsupportedKey = null;
        combo.forEach((key) => {
            if (!SUPPORTED_META_KEYS[key] && (!SUPPORTED_KEYS.test(key) || this._isSingleChar(key))) {
                unsupportedKey = key;
                return;
            }
        });
        return unsupportedKey;
    }
    _isSingleChar(key) {
        return key.length > 1;
    }
    _isSupportedShortcut(shortcut) {
        return SUPPORTED_SHORTCUTS[shortcut];
    }
}
ShortcutService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: ShortcutService, deps: [{ token: PLATFORM_ID }, { token: CONFIG }, { token: i1.KeyboardEventsService }], target: i0.ɵɵFactoryTarget.Injectable });
ShortcutService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: ShortcutService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: ShortcutService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [CONFIG]
                }] }, { type: i1.KeyboardEventsService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hvcnRjdXQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1kcmFnLXRvLXNlbGVjdC9zcmMvbGliL3Nob3J0Y3V0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRWxFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7OztBQUVsQyxNQUFNLG1CQUFtQixHQUFHO0lBQzFCLEdBQUcsRUFBRSxJQUFJO0lBQ1QsS0FBSyxFQUFFLElBQUk7SUFDWCxJQUFJLEVBQUUsSUFBSTtJQUNWLElBQUksRUFBRSxJQUFJO0NBQ1gsQ0FBQztBQUVGLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQztBQUUvQixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUM7QUFFeEIsTUFBTSxXQUFXLEdBQUc7SUFDbEIsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7Q0FDN0IsQ0FBQztBQUVGLE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsY0FBYyxFQUFFLElBQUk7SUFDcEIsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixnQkFBZ0IsRUFBRSxJQUFJO0lBQ3RCLGNBQWMsRUFBRSxJQUFJO0lBQ3BCLG1CQUFtQixFQUFFLElBQUk7Q0FDMUIsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLG1CQUFtQixDQUFDO0FBUXpDLE1BQU0sT0FB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QUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxhQUFhLENBQUMsS0FBWSxFQUFFLEdBQVc7UUFDN0MsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxLQUFvQjtRQUM1QyxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFFMUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3ZGLGNBQWMsR0FBRyxHQUFHLENBQUM7Z0JBQ3JCLE9BQU87YUFDUjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxjQUFjLENBQUM7SUFDeEIsQ0FBQztJQUVPLGFBQWEsQ0FBQyxHQUFXO1FBQy9CLE9BQU8sR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVPLG9CQUFvQixDQUFDLFFBQWdCO1FBQzNDLE9BQU8sbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkMsQ0FBQzs7NEdBdkpVLGVBQWUsa0JBTWhCLFdBQVcsYUFDWCxNQUFNO2dIQVBMLGVBQWU7MkZBQWYsZUFBZTtrQkFEM0IsVUFBVTs7MEJBT04sTUFBTTsyQkFBQyxXQUFXOzswQkFDbEIsTUFBTTsyQkFBQyxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IG1lcmdlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEtleWJvYXJkRXZlbnRzU2VydmljZSB9IGZyb20gJy4va2V5Ym9hcmQtZXZlbnRzLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBEcmFnVG9TZWxlY3RDb25maWcgfSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCB7IENPTkZJRyB9IGZyb20gJy4vdG9rZW5zJztcclxuXHJcbmNvbnN0IFNVUFBPUlRFRF9NRVRBX0tFWVMgPSB7XHJcbiAgYWx0OiB0cnVlLFxyXG4gIHNoaWZ0OiB0cnVlLFxyXG4gIG1ldGE6IHRydWUsXHJcbiAgY3RybDogdHJ1ZSxcclxufTtcclxuXHJcbmNvbnN0IFNVUFBPUlRFRF9LRVlTID0gL1thLXpdLztcclxuXHJcbmNvbnN0IE1FVEFfS0VZID0gJ21ldGEnO1xyXG5cclxuY29uc3QgS0VZX0FMSUFTRVMgPSB7XHJcbiAgW01FVEFfS0VZXTogWydjdHJsJywgJ21ldGEnXSxcclxufTtcclxuXHJcbmNvbnN0IFNVUFBPUlRFRF9TSE9SVENVVFMgPSB7XHJcbiAgbW92ZVJhbmdlU3RhcnQ6IHRydWUsXHJcbiAgZGlzYWJsZVNlbGVjdGlvbjogdHJ1ZSxcclxuICB0b2dnbGVTaW5nbGVJdGVtOiB0cnVlLFxyXG4gIGFkZFRvU2VsZWN0aW9uOiB0cnVlLFxyXG4gIHJlbW92ZUZyb21TZWxlY3Rpb246IHRydWUsXHJcbn07XHJcblxyXG5jb25zdCBFUlJPUl9QUkVGSVggPSAnW1Nob3J0Y3V0U2VydmljZV0nO1xyXG5cclxuaW50ZXJmYWNlIEtleVN0YXRlIHtcclxuICBjb2RlOiBzdHJpbmc7XHJcbiAgcHJlc3NlZDogYm9vbGVhbjtcclxufVxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgU2hvcnRjdXRTZXJ2aWNlIHtcclxuICBwcml2YXRlIF9zaG9ydGN1dHM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nW11bXSB9ID0ge307XHJcblxyXG4gIHByaXZhdGUgX2xhdGVzdFNob3J0Y3V0OiBNYXA8c3RyaW5nLCBib29sZWFuPiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxyXG4gICAgQEluamVjdChDT05GSUcpIGNvbmZpZzogRHJhZ1RvU2VsZWN0Q29uZmlnLFxyXG4gICAgcHJpdmF0ZSBrZXlib2FyZEV2ZW50czogS2V5Ym9hcmRFdmVudHNTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB0aGlzLl9zaG9ydGN1dHMgPSB0aGlzLl9jcmVhdGVTaG9ydGN1dHNGcm9tQ29uZmlnKGNvbmZpZy5zaG9ydGN1dHMpO1xyXG5cclxuICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XHJcbiAgICAgIGNvbnN0IGtleWRvd24kID0gdGhpcy5rZXlib2FyZEV2ZW50cy5rZXlkb3duJC5waXBlKFxyXG4gICAgICAgIG1hcDxLZXlib2FyZEV2ZW50LCBLZXlTdGF0ZT4oKGV2ZW50KSA9PiAoeyBjb2RlOiBldmVudC5jb2RlLCBwcmVzc2VkOiB0cnVlIH0pKVxyXG4gICAgICApO1xyXG5cclxuICAgICAgY29uc3Qga2V5dXAkID0gdGhpcy5rZXlib2FyZEV2ZW50cy5rZXl1cCQucGlwZShcclxuICAgICAgICBtYXA8S2V5Ym9hcmRFdmVudCwgS2V5U3RhdGU+KChldmVudCkgPT4gKHsgY29kZTogZXZlbnQuY29kZSwgcHJlc3NlZDogZmFsc2UgfSkpXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBtZXJnZTxLZXlTdGF0ZT4oa2V5ZG93biQsIGtleXVwJClcclxuICAgICAgICAucGlwZShcclxuICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChwcmV2LCBjdXJyKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmV2LnByZXNzZWQgPT09IGN1cnIucHJlc3NlZCAmJiBwcmV2LmNvZGUgPT09IGN1cnIuY29kZTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgICAgIC5zdWJzY3JpYmUoKGtleVN0YXRlKSA9PiB7XHJcbiAgICAgICAgICBpZiAoa2V5U3RhdGUucHJlc3NlZCkge1xyXG4gICAgICAgICAgICB0aGlzLl9sYXRlc3RTaG9ydGN1dC5zZXQoa2V5U3RhdGUuY29kZSwgdHJ1ZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9sYXRlc3RTaG9ydGN1dC5kZWxldGUoa2V5U3RhdGUuY29kZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkaXNhYmxlU2VsZWN0aW9uKGV2ZW50OiBFdmVudCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lzU2hvcnRjdXRQcmVzc2VkKCdkaXNhYmxlU2VsZWN0aW9uJywgZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgbW92ZVJhbmdlU3RhcnQoZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICByZXR1cm4gdGhpcy5faXNTaG9ydGN1dFByZXNzZWQoJ21vdmVSYW5nZVN0YXJ0JywgZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgdG9nZ2xlU2luZ2xlSXRlbShldmVudDogRXZlbnQpIHtcclxuICAgIHJldHVybiB0aGlzLl9pc1Nob3J0Y3V0UHJlc3NlZCgndG9nZ2xlU2luZ2xlSXRlbScsIGV2ZW50KTtcclxuICB9XHJcblxyXG4gIGFkZFRvU2VsZWN0aW9uKGV2ZW50OiBFdmVudCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lzU2hvcnRjdXRQcmVzc2VkKCdhZGRUb1NlbGVjdGlvbicsIGV2ZW50KTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUZyb21TZWxlY3Rpb24oZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICByZXR1cm4gdGhpcy5faXNTaG9ydGN1dFByZXNzZWQoJ3JlbW92ZUZyb21TZWxlY3Rpb24nLCBldmVudCk7XHJcbiAgfVxyXG5cclxuICBleHRlbmRlZFNlbGVjdGlvblNob3J0Y3V0KGV2ZW50OiBFdmVudCkge1xyXG4gICAgcmV0dXJuIHRoaXMuYWRkVG9TZWxlY3Rpb24oZXZlbnQpIHx8IHRoaXMucmVtb3ZlRnJvbVNlbGVjdGlvbihldmVudCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9jcmVhdGVTaG9ydGN1dHNGcm9tQ29uZmlnKHNob3J0Y3V0czogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSkge1xyXG4gICAgY29uc3Qgc2hvcnRjdXRNYXAgPSB7fTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIHNob3J0Y3V0c0ZvckNvbW1hbmRdIG9mIE9iamVjdC5lbnRyaWVzKHNob3J0Y3V0cykpIHtcclxuICAgICAgaWYgKCF0aGlzLl9pc1N1cHBvcnRlZFNob3J0Y3V0KGtleSkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5fZ2V0RXJyb3JNZXNzYWdlKGBTaG9ydGN1dCAke2tleX0gbm90IHN1cHBvcnRlZGApKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgc2hvcnRjdXRzRm9yQ29tbWFuZFxyXG4gICAgICAgIC5yZXBsYWNlKC8gL2csICcnKVxyXG4gICAgICAgIC5zcGxpdCgnLCcpXHJcbiAgICAgICAgLmZvckVhY2goKHNob3J0Y3V0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXNob3J0Y3V0TWFwW2tleV0pIHtcclxuICAgICAgICAgICAgc2hvcnRjdXRNYXBba2V5XSA9IFtdO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGNvbnN0IGNvbWJvID0gc2hvcnRjdXQuc3BsaXQoJysnKTtcclxuICAgICAgICAgIGNvbnN0IGNsZWFuQ29tYm9zID0gdGhpcy5fc3Vic3RpdHV0ZUtleShzaG9ydGN1dCwgY29tYm8sIE1FVEFfS0VZKTtcclxuXHJcbiAgICAgICAgICBjbGVhbkNvbWJvcy5mb3JFYWNoKChjbGVhbkNvbWJvKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVuc3VwcG9ydGVkS2V5ID0gdGhpcy5faXNTdXBwb3J0ZWRDb21ibyhjbGVhbkNvbWJvKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh1bnN1cHBvcnRlZEtleSkge1xyXG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLl9nZXRFcnJvck1lc3NhZ2UoYEtleSAnJHt1bnN1cHBvcnRlZEtleX0nIGluIHNob3J0Y3V0ICR7c2hvcnRjdXR9IG5vdCBzdXBwb3J0ZWRgKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHNob3J0Y3V0TWFwW2tleV0ucHVzaChcclxuICAgICAgICAgICAgICBjbGVhbkNvbWJvLm1hcCgoY29tYm9LZXkpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBTVVBQT1JURURfTUVUQV9LRVlTW2NvbWJvS2V5XSA/IGAke2NvbWJvS2V5fUtleWAgOiBgS2V5JHtjb21ib0tleS50b1VwcGVyQ2FzZSgpfWA7XHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBzaG9ydGN1dE1hcDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3N1YnN0aXR1dGVLZXkoc2hvcnRjdXQ6IHN0cmluZywgY29tYm86IEFycmF5PHN0cmluZz4sIHN1YnN0aXR1dGVLZXk6IHN0cmluZykge1xyXG4gICAgY29uc3QgaGFzU3BlY2lhbEtleSA9IHNob3J0Y3V0LmluY2x1ZGVzKHN1YnN0aXR1dGVLZXkpO1xyXG4gICAgY29uc3Qgc3Vic3RpdHV0ZWRTaG9ydGN1dDogc3RyaW5nW11bXSA9IFtdO1xyXG5cclxuICAgIGlmIChoYXNTcGVjaWFsS2V5KSB7XHJcbiAgICAgIGNvbnN0IGNsZWFuU2hvcnRjdXQgPSBjb21iby5maWx0ZXIoKGVsZW1lbnQpID0+IGVsZW1lbnQgIT09IE1FVEFfS0VZKTtcclxuXHJcbiAgICAgIEtFWV9BTElBU0VTLm1ldGEuZm9yRWFjaCgoYWxpYXMpID0+IHtcclxuICAgICAgICBzdWJzdGl0dXRlZFNob3J0Y3V0LnB1c2goWy4uLmNsZWFuU2hvcnRjdXQsIGFsaWFzXSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc3Vic3RpdHV0ZWRTaG9ydGN1dC5wdXNoKGNvbWJvKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc3Vic3RpdHV0ZWRTaG9ydGN1dDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2dldEVycm9yTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBgJHtFUlJPUl9QUkVGSVh9ICR7bWVzc2FnZX1gO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfaXNTaG9ydGN1dFByZXNzZWQoc2hvcnRjdXROYW1lOiBzdHJpbmcsIGV2ZW50OiBFdmVudCkge1xyXG4gICAgY29uc3Qgc2hvcnRjdXRzID0gdGhpcy5fc2hvcnRjdXRzW3Nob3J0Y3V0TmFtZV07XHJcblxyXG4gICAgcmV0dXJuIHNob3J0Y3V0cy5zb21lKChzaG9ydGN1dCkgPT4ge1xyXG4gICAgICByZXR1cm4gc2hvcnRjdXQuZXZlcnkoKGtleSkgPT4gdGhpcy5faXNLZXlQcmVzc2VkKGV2ZW50LCBrZXkpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfaXNLZXlQcmVzc2VkKGV2ZW50OiBFdmVudCwga2V5OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBrZXkuc3RhcnRzV2l0aCgnS2V5JykgPyB0aGlzLl9sYXRlc3RTaG9ydGN1dC5oYXMoa2V5KSA6IGV2ZW50W2tleV07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9pc1N1cHBvcnRlZENvbWJvKGNvbWJvOiBBcnJheTxzdHJpbmc+KSB7XHJcbiAgICBsZXQgdW5zdXBwb3J0ZWRLZXkgPSBudWxsO1xyXG5cclxuICAgIGNvbWJvLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICBpZiAoIVNVUFBPUlRFRF9NRVRBX0tFWVNba2V5XSAmJiAoIVNVUFBPUlRFRF9LRVlTLnRlc3Qoa2V5KSB8fCB0aGlzLl9pc1NpbmdsZUNoYXIoa2V5KSkpIHtcclxuICAgICAgICB1bnN1cHBvcnRlZEtleSA9IGtleTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB1bnN1cHBvcnRlZEtleTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2lzU2luZ2xlQ2hhcihrZXk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGtleS5sZW5ndGggPiAxO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfaXNTdXBwb3J0ZWRTaG9ydGN1dChzaG9ydGN1dDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gU1VQUE9SVEVEX1NIT1JUQ1VUU1tzaG9ydGN1dF07XHJcbiAgfVxyXG59XHJcbiJdfQ==